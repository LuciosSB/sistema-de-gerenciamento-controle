<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>Gerenciar Solicita√ß√µes</title>
</head>
<body>
    <!-- Cabe√ßalho do Sistema -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">Sistema de Solicita√ß√µes</div>
                <div class="user-info">
                    <div class="user-icon">üë§</div>
                    <span class="user-name">Administrador</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Navega√ß√£o -->
    <nav>
        <div class="container">
            <ul class="nav-list">
                <li><a href="{{ url_for('exibir_index') }}">P√°gina Inicial</a></li>
                <li class="active"><a href="{{ url_for('gerenciar_solicitacoes') }}">Gerenciar Solicita√ß√µes</a></li>
                <li><a href="{{ url_for('cadastro_produto') }}">Cadastro</a></li>
                <li><a href="{{ url_for('listar_produtos') }}">Listar Produtos</a></li>
                <li><a href="{{ url_for('selecionar_produto_atualizar') }}">Atualizar Produtos</a></li>
                <li><a href="{{ url_for('saida_produto') }}">Sa√≠da de Produtos</a></li>
            </ul>
        </div>
    </nav>

    <!-- Conte√∫do Principal -->
    <div class="container">
        <div class="main-content">
            <div class="panel active" id="solicitacoes-panel">
                <div class="panel-header">
                    <div class="header-row">
                        <h2>Gerenciar Solicita√ß√µes</h2>
                        
                        <!-- Bot√£o de Auto-Refresh sutil -->
                        <button id="autoRefreshBtn" class="btn-auto-refresh" onclick="toggleAutoRefresh()" title="Ativar atualiza√ß√£o autom√°tica a cada minuto">
                            üîÑ
                        </button>
                        
                        <span class="solicitacao-count">{{ solicitacoes|length }} solicita√ß√£o(√µes) encontrada(s)</span>
                    </div>
                    
                    <!-- Status do refresh (s√≥ aparece quando ativo) -->
                    <div class="refresh-status" id="refreshStatus" style="display: none;">
                        <span class="countdown" id="countdown"></span>
                    </div>
                </div>
                <div class="panel-content">
                    <!-- Container da tabela com borda -->
                    <div class="table-container">
                        {% if solicitacoes %}
                        <div class="table-wrapper">
                            <table class="solicitacoes-table">
                                <thead>
                                    <tr>
                                        <th class="col-numero">ID</th>
                                        <th class="col-nome">Nome da Pessoa</th>
                                        <th class="col-setor">Setor</th>
                                        <th class="col-item">Item</th>
                                        <th class="col-quantidade">Quantidade</th>
                                        <th class="col-horario">Data/Hora</th>
                                        <th class="col-status">Status</th>
                                        <th class="col-acoes">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for solicitacao in solicitacoes %}
                                    <tr class="solicitacao-row">
                                        <td class="solicitacao-numero">{{ solicitacao.id }}</td>
                                        <td class="solicitacao-nome">{{ solicitacao.nome_solicitante }}</td>
                                        <td class="solicitacao-setor">{{ solicitacao.setor }}</td>
                                        <td class="solicitacao-item">{{ solicitacao.nome_item }}</td>
                                        <td class="solicitacao-quantidade">{{ solicitacao.quantidade }}</td>
                                        <td class="solicitacao-horario">{{ solicitacao.data_solicitacao.strftime('%d/%m/%Y %H:%M') }}</td>
                                        <td class="solicitacao-status">
                                            <div class="status-badge 
                                                {% if solicitacao.status == 'pendente' %}status-pendente
                                                {% elif solicitacao.status == 'aprovada' %}status-aprovada
                                                {% elif solicitacao.status == 'rejeitada' %}status-rejeitada
                                                {% elif solicitacao.status == 'entregue' %}status-entregue
                                                {% endif %}">
                                                {% if solicitacao.status == 'pendente' %}
                                                    üîÑ Pendente
                                                {% elif solicitacao.status == 'aprovada' %}
                                                    ‚úÖ Aprovada
                                                {% elif solicitacao.status == 'rejeitada' %}
                                                    ‚ùå Rejeitada
                                                {% elif solicitacao.status == 'entregue' %}
                                                    üì¶ Entregue
                                                {% else %}
                                                    {{ solicitacao.status }}
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td class="solicitacao-acoes">
                                            <a href="{{ url_for('gerenciar_solicitacoes_detalhes', solicitacao_id=solicitacao.id) }}" class="btn-acao btn-visualizar">
                                                üëÅÔ∏è Visualizar
                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <!-- Mensagem quando n√£o h√° solicita√ß√µes -->
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <h3>Nenhuma solicita√ß√£o encontrada</h3>
                            <p>N√£o h√° solicita√ß√µes registradas no sistema no momento.</p>
                            <p>Voce pode criar uma solicita√ß√£o no Portal de Solicita√ß√µes</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- A√ß√µes da p√°gina -->
                    <div class="page-actions">
                        <a href="{{ url_for('portal_solicitacoes') }}" class="btn btn-primary">
                            ‚ûï Portal de Solicita√ß√µes
                        </a>
                        <a href="{{ url_for('exibir_index') }}" class="btn btn-secondary">
                            üè† P√°gina Inicial
                        </a>
                        <button onclick="location.reload()" class="btn btn-primary">
                            üîÑ Atualizar Lista
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval;
        let countdownInterval;
        let isAutoRefreshActive = false;
        let secondsRemaining = 60;

        // Chave para localStorage
        const AUTO_REFRESH_KEY = 'autoRefreshActive';
        const REFRESH_TIME_KEY = 'refreshTimeRemaining';

        // Fun√ß√£o para salvar estado no localStorage
        function saveAutoRefreshState(active, timeRemaining = 60) {
            localStorage.setItem(AUTO_REFRESH_KEY, active.toString());
            if (active) {
                localStorage.setItem(REFRESH_TIME_KEY, timeRemaining.toString());
            } else {
                localStorage.removeItem(REFRESH_TIME_KEY);
            }
        }

        // Fun√ß√£o para carregar estado do localStorage
        function loadAutoRefreshState() {
            const savedState = localStorage.getItem(AUTO_REFRESH_KEY);
            const savedTime = localStorage.getItem(REFRESH_TIME_KEY);
            
            if (savedState === 'true') {
                isAutoRefreshActive = true;
                // Se h√° tempo salvo e √© v√°lido, usa ele; sen√£o, usa 60 segundos
                secondsRemaining = (savedTime && parseInt(savedTime) > 0) ? parseInt(savedTime) : 60;
                
                // Atualiza a interface
                const btn = document.getElementById('autoRefreshBtn');
                const status = document.getElementById('refreshStatus');
                
                btn.classList.add('active');
                btn.title = 'Desativar atualiza√ß√£o autom√°tica';
                status.style.display = 'block';
                
                // Inicia o auto-refresh
                startAutoRefresh();
            }
        }

        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            const status = document.getElementById('refreshStatus');

            if (!isAutoRefreshActive) {
                // Ativar auto-refresh
                isAutoRefreshActive = true;
                btn.classList.add('active');
                btn.title = 'Desativar atualiza√ß√£o autom√°tica';
                status.style.display = 'block';
                
                // Salva o estado ativo
                saveAutoRefreshState(true, 60);
                
                startAutoRefresh();
            } else {
                // Desativar auto-refresh
                isAutoRefreshActive = false;
                btn.classList.remove('active');
                btn.title = 'Ativar atualiza√ß√£o autom√°tica a cada minuto';
                status.style.display = 'none';
                
                // Remove o estado do localStorage
                saveAutoRefreshState(false);
                
                // Limpa os intervalos
                clearInterval(autoRefreshInterval);
                clearInterval(countdownInterval);
            }
        }

        function startAutoRefresh() {
            // Se n√£o h√° tempo restante definido, come√ßa com 60 segundos
            if (!secondsRemaining || secondsRemaining <= 0) {
                secondsRemaining = 60;
            }
            
            updateCountdown();
            
            countdownInterval = setInterval(() => {
                secondsRemaining--;
                updateCountdown();
                
                // Salva o tempo restante no localStorage
                saveAutoRefreshState(true, secondsRemaining);
                
                if (secondsRemaining <= 0) {
                    // Quando chegar a 0, recarrega a p√°gina
                    // O tempo ser√° resetado quando a p√°gina carregar novamente
                    saveAutoRefreshState(true, 60);
                    location.reload();
                }
            }, 1000);

            // Remove o autoRefreshInterval de 60 segundos pois agora o reload
            // acontece quando o countdown chega a 0
        }

        function updateCountdown() {
            const countdown = document.getElementById('countdown');
            countdown.textContent = `Pr√≥xima atualiza√ß√£o em: ${secondsRemaining}s`;
        }

        // Carrega o estado quando a p√°gina √© carregada
        document.addEventListener('DOMContentLoaded', function() {
            loadAutoRefreshState();
        });

        // Limpar intervalos quando a p√°gina for fechada
        window.addEventListener('beforeunload', function() {
            // Salva o tempo restante antes de sair
            if (isAutoRefreshActive && secondsRemaining > 0) {
                saveAutoRefreshState(true, secondsRemaining);
            }
            
            clearInterval(autoRefreshInterval);
            clearInterval(countdownInterval);
        });

        // Fun√ß√£o para limpar o estado (√∫til para debug ou reset manual)
        function resetAutoRefresh() {
            localStorage.removeItem(AUTO_REFRESH_KEY);
            localStorage.removeItem(REFRESH_TIME_KEY);
            location.reload();
        }
    </script>
</body>
</html>