{% extends "base.html" %}

{% block title %}Atualizar Usu√°rio - {{ usuario.username }}{% endblock %}

{% block content %}
    <nav>
        <div class="container">
            <ul class="nav-list">
                <li><a href="{{ url_for('exibir_index') }}">P√°gina Inicial</a></li>
                <li><a href="{{ url_for('cadastro_usuario') }}">Cadastro de Usu√°rio</a></li>
                <li class="active"><a href="{{ url_for('lista_usuarios') }}">Lista de Usu√°rios</a></li>
                <li><a href="{{ url_for('historico') }}">Hist√≥rico</a></li>
            </ul>
        </div>
    </nav>

    <div class="panel active" id="atualizar-usuario-panel">
        <div class="panel-header">
            <h2>Atualizar Usu√°rio</h2>
            <div class="header-actions">
                <span class="usuario-info-badge">
                    ID: {{ usuario.id }} |
                    {% if usuario.ativo %}
                        <span class="status-ativo">‚óè</span> ATIVO
                    {% else %}
                        <span class="status-inativo">‚óè</span> INATIVO
                    {% endif %}
                </span>
            </div>
        </div>

        <div class="panel-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">
                            <span class="alert-icon">
                                {% if category == 'success' %}‚úÖ
                                {% elif category == 'error' %}‚ùå
                                {% elif category == 'warning' %}‚ö†Ô∏è
                                {% else %}‚ÑπÔ∏è{% endif %}
                            </span>
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="form-container">
                <form method="POST" class="usuario-form" id="updateUserForm">
                    <div class="form-section">
                        <h3 class="section-title">
                            <span class="section-icon">üë§</span>
                            Informa√ß√µes do Usu√°rio
                        </h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="username">Nome de Usu√°rio <span class="required">*</span></label>
                                <input type="text"
                                       id="username"
                                       name="username"
                                       value="{{ usuario.username }}"
                                       required
                                       placeholder="Digite o nome de usu√°rio">
                            </div>

                            <div class="form-group">
                                <label for="dados">Dados do Usu√°rio <span class="required">*</span></label>
                                <input type="text"
                                       id="dados"
                                       name="dados"
                                       value="{{ usuario.dados }}"
                                       required
                                       placeholder="Digite os dados do usu√°rio">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">
                            <span class="section-icon">üîê</span>
                            Configura√ß√µes de Acesso
                        </h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="tipo_usuario">Tipo de Usu√°rio <span class="required">*</span></label>
                                        <select id="tipo_usuario" name="tipo_usuario" required>
                                            <option value="admin" {% if usuario.tipo_usuario == 'admin' %}selected{% endif %}>
                                                üëë Administrador
                                            </option>
                                            <option value="manutencao" {% if usuario.tipo_usuario == 'manutencao' %}selected{% endif %}>
                                                üì¶ Manuten√ß√£o
                                            </option>
                                            <option value="usuario_padrao" {% if usuario.tipo_usuario == 'usuario_padrao' %}selected{% endif %}>
                                                ‚ö° Usu√°rio Padr√£o
                                            </option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox"
                                           id="ativo"
                                           name="ativo"
                                           {% if usuario.ativo %}checked{% endif %}>
                                    <span class="checkbox-custom"></span>
                                    <span class="checkbox-text">Usu√°rio Ativo</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">
                            <span class="section-icon">üîë</span>
                            Alterar Senha (Opcional)
                        </h3>

                        <div class="form-row">
                            <div class="form-group password-group">
                                <label for="nova_senha">Nova Senha</label>
                                <div class="password-input-wrapper">
                                    <input type="password"
                                           id="nova_senha"
                                           name="nova_senha"
                                           placeholder="Digite a nova senha (m√≠nimo 6 caracteres)"
                                           minlength="6">
                                    <button type="button" class="password-toggle" onclick="togglePassword('nova_senha')">
                                        üëÅÔ∏è
                                    </button>
                                </div>
                                <small class="form-help">Deixe em branco para manter a senha atual</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            üíæ Salvar Altera√ß√µes
                        </button>
                        <a href="{{ url_for('lista_usuarios') }}" class="btn btn-secondary">
                            ‚Ü©Ô∏è Voltar para Lista
                        </a>
                    </div>
                </form>
            </div>

            <div class="danger-zone">
                <h3 class="danger-title">
                    <span class="danger-icon">‚ö†Ô∏è</span>
                    Zona de Perigo
                </h3>
                <p class="danger-description">
                    A exclus√£o do usu√°rio √© permanente e n√£o pode ser desfeita.
                    Todos os dados associados ser√£o perdidos.
                </p>

                <form method="POST"
                      action="{{ url_for('excluir_usuario', usuario_id=usuario.id) }}"
                      onsubmit="return confirmDelete('{{ usuario.username }}')"
                      class="delete-form">
                    <button type="submit" class="btn btn-danger">
                        üóëÔ∏è Excluir Usu√°rio Permanentemente
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Fun√ß√£o para mostrar/ocultar senha
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;

            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }

        // Confirma√ß√£o de exclus√£o
        function confirmDelete(username) {
            return confirm(
                `‚ö†Ô∏è ATEN√á√ÉO!\n\n` +
                `Voc√™ est√° prestes a EXCLUIR PERMANENTEMENTE o usu√°rio "${username}".\n\n` +
                `Esta a√ß√£o N√ÉO PODE ser desfeita!\n\n` +
                `Deseja realmente continuar?`
            );
        }

        // Valida√ß√£o do formul√°rio
        document.getElementById('updateUserForm').addEventListener('submit', function(e) {
            const username = document.getElementById('username').value.trim();
            const dados = document.getElementById('dados').value.trim();
            const novaSenha = document.getElementById('nova_senha').value;

            if (!username) {
                alert('‚ùå Nome de usu√°rio √© obrigat√≥rio!');
                e.preventDefault();
                return;
            }

            if (!dados) {
                alert('‚ùå Dados do usu√°rio s√£o obrigat√≥rios!');
                e.preventDefault();
                return;
            }

            if (novaSenha && novaSenha.length < 6) {
                alert('‚ùå A nova senha deve ter pelo menos 6 caracteres!');
                e.preventDefault();
                return;
            }

            // Confirma√ß√£o das altera√ß√µes
            if (!confirm('üíæ Confirma as altera√ß√µes no usu√°rio?')) {
                e.preventDefault();
            }
        });

        // Auto-resize para campos de texto longos
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('input[type="text"]');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = this.scrollHeight + 'px';
                });
            });
        });
    </script>
{% endblock %}